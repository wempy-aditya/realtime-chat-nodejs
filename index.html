<!doctype html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-CuOF+2SnTUfTwSZjCXf01h7uYhfOBuxIhGKPbfEJ3+FqH/s6cIFN9bGr1HmAg4fQ" crossorigin="anonymous">
    <title>Real Time Chat | Room</title>

	<script>
		if (localStorage.getItem("loginSession") == undefined) {
			window.location.href = "/";
		} 
	</script>

    <style>
		body {
			padding-top: 4.5rem;
		}
		.bd-placeholder-img {
			font-size: 1.125rem;
			text-anchor: middle;
			-webkit-user-select: none;
			-moz-user-select: none;
			user-select: none;
		}
		@media (min-width: 768px) {
			.bd-placeholder-img-lg {
			font-size: 3.5rem;
			}
		}
    </style>

</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
		<div class="container-fluid">
			<a class="navbar-brand">
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-chat-right-text" viewBox="0 0 16 16">
					<path d="M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1H2zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12z"/>
					<path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
				</svg>
				WAW messenger
			</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="collapse navbar-collapse" id="navbarsExampleDefault">
				<ul class="navbar-nav mr-auto mb-2 mb-md-0">
					<li class="nav-item active">
						<a class="nav-link">Hello <span id="welcomeMesage"></span>!</a>
					</li>
				</ul>
				<div class="d-flex">
					<button class="btn btn-danger" onclick="logOut()">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-box-arrow-right" viewBox="0 0 16 16">
							<path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
							<path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
						</svg>
						Logout 
					</button>
				</div>
			</div>
		</div>
	</nav>

	<main class="container-fluid">
		<div class="row">
			<div class="col-md-3 mb-3">
				<div class="card">
					<div class="card-body">
						<div class="alert alert-primary" role="alert">
							<b>Total : </b><span id="totalUserOnline"></span> Orang Online
						</div>
						<ul>
							<li id="ownDevices"></li>
						</ul>
					</div>
				</div>
			</div>
			<div class="col-md-9">
				<div class="card">
					<div class="card-body">
						<div class="alert alert-primary" role="alert">
							<b>Chatting Room</b>
							<!-- <p class="text-right">2020-10-19</p> -->
						</div>
						<div id="listMessage" style="height:60vh;overflow-y:auto;">
							<!-- <div class="card mb-3"><div class="card-body"><b>wempy aditya</b><br><span>fdgfdg</span></div></div> -->
						</div>
						<div class="card mb-2">
							<div class="card-body">
								<div class="row">
									<div class="col-10">
										<input type="text" name="txtMessage" id="txtMessage" class="form-control" autofocus>
									</div>
									<div class="col-2">
										<button class="btn btn-primary" id="sendButton">
											<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cursor-fill" viewBox="0 0 16 16">
												<path d="M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103z"/>
											</svg>
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-popRpmFF9JQgExhfw5tZT4I9/CI5e2QcuUZPOVXb1m7qUmeR2b50u+YFEYe1wgzy" crossorigin="anonymous"></script>

	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		
		var socket = io()
	
		socket.emit('join')
	
		socket.on('message', (param) => {
			document.getElementById("txtMessage").value = "";

			var cardDiv = document.createElement("div");
			cardDiv.className = 'card mb-3';
	
			var cardBody = document.createElement("div");
			cardBody.className = 'card-body';
			
			var messageSender = document.createElement("b");
			messageSender.appendChild(document.createTextNode(param.sender));
			cardBody.appendChild(messageSender);
			
			var gap = document.createElement("br");
			cardBody.appendChild(gap);

			var messageItem = document.createElement("span");
			messageItem.appendChild(document.createTextNode(param.text));
			cardBody.appendChild(messageItem);
	
			cardDiv.appendChild(cardBody);
	
			document.getElementById("listMessage").appendChild(cardDiv);
	
			updateScroll();
		})
	
		socket.on('countUserOnline', (countUserOnline) => {
			// alert(countUserOnline)
			document.getElementById("totalUserOnline").innerHTML = countUserOnline;
		})
	
		var inputMessage = document.getElementById("txtMessage");
		inputMessage.addEventListener("keyup", function(event) { 
			if (event.keyCode === 13) { 
				event.preventDefault();
				sendMessage();
			}
		});

		document.getElementById("sendButton").addEventListener("click", sendMessage);
		function sendMessage() {
			var message = document.getElementById("txtMessage").value; 
			var valid = message.length;
			if (valid != 0) {
				var pengirim = localStorage.getItem("loginSession");
				socket.emit('message', {
					text: message,
					sender: pengirim
				}); 
			}
		} 
	
		function updateScroll(){
			var element = document.getElementById("listMessage");
			element.scrollTop = element.scrollHeight;
		}

		document.getElementById("welcomeMesage").innerHTML = localStorage.getItem("loginSession");
		document.getElementById("ownDevices").innerHTML = localStorage.getItem("loginSession");
		
		function logOut() {
			event.preventDefault();
			localStorage.removeItem("loginSession");
			window.location.href = "/";
		}
	</script>

</body>
</html>